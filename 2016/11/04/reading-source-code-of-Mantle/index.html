

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="斌哥">
  <meta name="keywords" content="">
  
    <meta name="description" content="Mantle 解读Mantle 是由 Github 开发一款模型框架，Mantle 的主要作用在于让开发者更简单的构建应用的 model 层。本文主要介绍 Mantle 中最常使用的 JSON 功能–字典转模型。 Mantle 的使用先以知乎的一个 API 为例，讲解如何使用 Mantle 为这个 API 构建 model 。   1.按照 Mantle 要求构建对应的 model，Mantle">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 模型框架- Mantle 解读">
<meta property="og:url" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/index.html">
<meta property="og:site_name" content="要上班的斌哥">
<meta property="og:description" content="Mantle 解读Mantle 是由 Github 开发一款模型框架，Mantle 的主要作用在于让开发者更简单的构建应用的 model 层。本文主要介绍 Mantle 中最常使用的 JSON 功能–字典转模型。 Mantle 的使用先以知乎的一个 API 为例，讲解如何使用 Mantle 为这个 API 构建 model 。   1.按照 Mantle 要求构建对应的 model，Mantle">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled1.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled2.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled3.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled4.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled5.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled6.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled7.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled8.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled9.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled10.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled11.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled12.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled13.webp">
<meta property="og:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled14.webp">
<meta property="article:published_time" content="2016-11-04T02:22:24.000Z">
<meta property="article:modified_time" content="2022-05-26T02:42:41.112Z">
<meta property="article:author" content="斌哥">
<meta property="article:tag" content="源码解读">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/Untitled.webp">
  
  
  
  <title>iOS 模型框架- Mantle 解读 - 要上班的斌哥</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"junbinchencn.github.io","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="iOS 模型框架- Mantle 解读"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2016-11-04 10:22" pubdate>
          2016年11月4日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          27k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          229 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">iOS 模型框架- Mantle 解读</h1>
            
            <div class="markdown-body">
              
              <h1 id="Mantle-解读"><a href="#Mantle-解读" class="headerlink" title="Mantle 解读"></a>Mantle 解读</h1><p><a target="_blank" rel="noopener" href="https://github.com/Mantle/Mantle/">Mantle</a> 是由 Github 开发一款模型框架，Mantle 的主要作用在于让开发者更简单的构建应用的 model 层。本文主要介绍 Mantle 中最常使用的 JSON 功能–字典转模型。</p>
<h3 id="Mantle-的使用"><a href="#Mantle-的使用" class="headerlink" title="Mantle 的使用"></a>Mantle 的使用</h3><p>先以知乎的一个 <a target="_blank" rel="noopener" href="http://news-at.zhihu.com/api/4/news/latest">API</a> 为例，讲解如何使用 Mantle 为这个 API 构建 model 。</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled.webp" srcset="/img/loading.gif" lazyload class="" title="API的数据结构">

<p>1.按照 Mantle 要求构建对应的 model，Mantle 要求所有的 Model 都要继承于 MTLModel 并实现 MTLJSONSerializing 协议</p>
<p>构建 ZhihuLatestNews model 对应返回的 JSONKeyPath</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled1.webp" srcset="/img/loading.gif" lazyload class="" title="image">
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled2.webp" srcset="/img/loading.gif" lazyload class="" title="image">


<p>构建 ZhihuStory model 对应 sotries 的JSONkeyPath</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled3.webp" srcset="/img/loading.gif" lazyload class="" title="image">
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled4.webp" srcset="/img/loading.gif" lazyload class="" title="image">

<p>构建 ZhihuStory model 对应 top_sotries 的JSONkeyPath</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled5.webp" srcset="/img/loading.gif" lazyload class="" title="image">
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled6.webp" srcset="/img/loading.gif" lazyload class="" title="image">


<p>2.将网络请求的结果使用 Manlte 转化成 model</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled7.webp" srcset="/img/loading.gif" lazyload class="" title="image">


<h3 id="Mantle的接口"><a href="#Mantle的接口" class="headerlink" title="Mantle的接口"></a>Mantle的接口</h3><p>Mantle 通过 MTLJSONAdapter 实现 字典和 model 之间的转化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CPP">ZhihuLatestNews *lateNews = [MTLJSONAdapter modelOfClass:ZhihuLatestNews.<span class="hljs-keyword">class</span> fromJSONDictionary:dict error:&amp;merror];<br></code></pre></td></tr></table></figure>


<h3 id="Mantle的核心操作步骤"><a href="#Mantle的核心操作步骤" class="headerlink" title="Mantle的核心操作步骤"></a>Mantle的核心操作步骤</h3><p>1.获取 model 的属性–&gt; JSONKeyPath 映射字典<br>2.获取 model 的属性列表<br>3.根据 model 的方法给网络请求中返回的 JSON 字典中的 value 做值类型转化操作<br>4.使用 KVC 把值赋给 model 的属性，完成操作</p>
<h3 id="Mantle-的-JSON字典–-gt-model-方法调用层级-Mantle-源码解读过程中主要是参考这个调用过程"><a href="#Mantle-的-JSON字典–-gt-model-方法调用层级-Mantle-源码解读过程中主要是参考这个调用过程" class="headerlink" title="Mantle 的 JSON字典–&gt; model 方法调用层级,Mantle 源码解读过程中主要是参考这个调用过程"></a>Mantle 的 JSON字典–&gt; model 方法调用层级,Mantle 源码解读过程中主要是参考这个调用过程</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><br>| +[MTLJSONAdapter modelOfClass:fromJSONDictionary:error:]<span class="hljs-comment">// Mantle 调用入口</span><br>|   [&lt;MTLJSONAdapter <span class="hljs-number">0x7fe68bd64340</span>&gt; initWithModelClass:]<span class="hljs-comment">// 创建 MTLJSONAdapter </span><br>|     +[ZhihuLatestNews JSONKeyPathsByPropertyKey]<span class="hljs-comment">// 获取 属性-&gt; JSONKeyPath 映射字典</span><br>|     +[ZhihuLatestNews propertyKeys] <span class="hljs-comment">// 获取 model 的所有 Mantle 可用属性</span><br>|       +[ZhihuLatestNews enumeratePropertiesUsingBlock:]<br>|         +[ZhihuLatestNews storageBehaviorForPropertyWithKey:] <span class="hljs-comment">// 判断 model 的属性是否 Mantle 要求</span><br><br>| From: -[MTLJSONAdapter initWithModelClass:]<br>| +[MTLJSONAdapter valueTransformersForModelClass:] <span class="hljs-comment">//值转化</span><br>|   +[ZhihuLatestNews propertyKeys]<br>|   +[MTLJSONAdapter transformerForModelPropertiesOfClass:]<br><br>| From: +[MTLJSONAdapter modelOfClass:fromJSONDictionary:error:]<br>| [&lt;MTLJSONAdapter <span class="hljs-number">0x7fe68bd64340</span>&gt; modelFromJSONDictionary:error:] <br>|   +[ZhihuLatestNews propertyKeys] <span class="hljs-comment">// 获取 model 的所有 Mantle 可用属性</span><br>|   +[ZhihuLatestNews modelWithDictionary:error:] <span class="hljs-comment">//生成 model 对象</span><br>|     [&lt;ZhihuLatestNews <span class="hljs-number">0x7fe68bf2dea0</span>&gt; initWithDictionary:error:]<br>|       [&lt;ZhihuLatestNews <span class="hljs-number">0x7fe68bf2dea0</span>&gt; init]<br>|       [&lt;ZhihuLatestNews <span class="hljs-number">0x7fe68bf2dea0</span>&gt; setDate:]<br>|   [&lt;ZhihuLatestNews <span class="hljs-number">0x7fe68bf2dea0</span>&gt; validate:]<br>|     +[ZhihuLatestNews propertyKeys]<br><br></code></pre></td></tr></table></figure>



<h3 id="Mantle的源码解读"><a href="#Mantle的源码解读" class="headerlink" title="Mantle的源码解读"></a>Mantle的源码解读</h3><p>1.初始化 MTLJSONAdapter</p>
<p>MTLJSONAdapter 是 字典和 model 之间的适配器，将 JSON 字典 转成应用的 model 对象</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled8.webp" srcset="/img/loading.gif" lazyload class="" title="image">


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CPP">+ (id)modelOfClass:(Class)modelClass fromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error &#123;<br>     <span class="hljs-comment">//初始化MTLJSONAdapter</span><br>	MTLJSONAdapter *adapter = [[self alloc] initWithModelClass:modelClass];<br><br>	<span class="hljs-keyword">return</span> [adapter modelFromJSONDictionary:JSONDictionary error:error];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.initWithModelClass:(Class)modelClass 的作用是使用给定的 modelClass 初始化 MTLJSONAdapter</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled9.webp" srcset="/img/loading.gif" lazyload class="" title="image">


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs CPP">- (id)initWithModelClass:(Class)modelClass &#123;<br>  <br>    <span class="hljs-comment">//对modelClass进行判空操作</span><br>	<span class="hljs-built_in">NSParameterAssert</span>(modelClass != nil);<br>    <span class="hljs-comment">//是否实现MTLJSONSerializing协议的判断，对是否继承了MTLModel进行确认</span><br>	<span class="hljs-built_in">NSParameterAssert</span>([modelClass conformsToProtocol:@<span class="hljs-built_in">protocol</span>(MTLJSONSerializing)]);<br><br>	self = [super init];<br>	<span class="hljs-keyword">if</span> (self == nil) <span class="hljs-keyword">return</span> nil;<br><br>    <span class="hljs-comment">//使用变量保存modelClass，以便后续使用</span><br>     _modelClass = modelClass;<br><br>    <span class="hljs-comment">//获取属性值和JSONKeyPaths的映射字典，并使用_JSONKeyPathsByPropertyKey保存</span><br>    <span class="hljs-comment">//JSONKeyPathsByPropertyKey 是 MTLJSONSerializing 协议中定义的一个方法，在MTLModel的子类中实现</span><br>	_JSONKeyPathsByPropertyKey = [modelClass JSONKeyPathsByPropertyKey];<br><br>   <span class="hljs-comment">//获取 model 的属性，保存在propertyKeys变量中</span><br>   <span class="hljs-comment">//  **该方法后文有详细的实现解读**</span><br>	NSSet *propertyKeys = [self.modelClass propertyKeys];<br><br>     <span class="hljs-comment">//判断 _JSONKeyPathsByPropertyKey 是否包含在 propertyKeys 里面,</span><br>     <span class="hljs-comment">//用来确认 _JSONKeyPathsByPropertyKey 里面的 key 都是 model 的属性</span><br>	<span class="hljs-keyword">for</span> (NSString *mappedPropertyKey in _JSONKeyPathsByPropertyKey) &#123;<br>		<span class="hljs-keyword">if</span> (![propertyKeys containsObject:mappedPropertyKey]) &#123;<br>			<span class="hljs-built_in">NSAssert</span>(NO, @<span class="hljs-string">&quot;%@ is not a property of %@.&quot;</span>, mappedPropertyKey, modelClass);<br>			<span class="hljs-keyword">return</span> nil;<br>		&#125;<br>        <span class="hljs-comment">//根据 model 的属性 key 取出 JSONKeyPath</span><br>		id value = _JSONKeyPathsByPropertyKey[mappedPropertyKey];<br>        <span class="hljs-comment">//TODO [value isKindOfClass:NSArray.class] 这个是判断什么呢？在哪里用到呢？在文章末尾说明1</span><br>		<span class="hljs-keyword">if</span> ([value isKindOfClass:NSArray.<span class="hljs-keyword">class</span>]) &#123;<br>			<span class="hljs-keyword">for</span> (NSString *keyPath in value) &#123;<br>				<span class="hljs-keyword">if</span> ([keyPath isKindOfClass:NSString.<span class="hljs-keyword">class</span>]) <span class="hljs-keyword">continue</span>;<br>				<span class="hljs-built_in">NSAssert</span>(NO, @<span class="hljs-string">&quot;%@ must either map to a JSON key path or a JSON array of key paths, got: %@.&quot;</span>, mappedPropertyKey, value);<br>				<span class="hljs-keyword">return</span> nil;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (![value isKindOfClass:NSString.<span class="hljs-keyword">class</span>]) &#123;<br>			<span class="hljs-built_in">NSAssert</span>(NO, @<span class="hljs-string">&quot;%@ must either map to a JSON key path or a JSON array of key paths, got: %@.&quot;</span>,mappedPropertyKey, value);<br>			<span class="hljs-keyword">return</span> nil;<br>		&#125;<br>	&#125;<br>    <span class="hljs-comment">//获取 model 属性的 valueTransformers 用于做类型转化</span><br>    <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>	_valueTransformersByPropertyKey = [self.<span class="hljs-keyword">class</span> valueTransformersForModelClass:modelClass];<br>    <span class="hljs-comment">//A new map table object which has strong references to the keys and values.</span><br>	_JSONAdaptersByModelClass = [NSMapTable strongToStrongObjectsMapTable];<br><br>	<span class="hljs-keyword">return</span> self;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.MTLModel的propertyKeys类方法,该方法会返回一个包含 model 属性列表的 NSSet 数据，但是这个 NSSet 数据不包含 被 readonly 修饰的属性，没有 ivars 变量的属性，以及 MTLModel 类自身的属性。除此之外的所有通过 @property 声明的属性都会存在 NSSet 数据中，</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled10.webp" srcset="/img/loading.gif" lazyload class="" title="image">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">/// Returns the keys for all @property declarations, except for `readonly`</span><br><span class="hljs-comment">/// properties without ivars, or properties on MTLModel itself.</span><br>+ (NSSet *)propertyKeys &#123;<br>    <span class="hljs-comment">// 判断 model 中 是否有属性列表的缓存，若有直接返回</span><br>	NSSet *cachedKeys = <span class="hljs-built_in">objc_getAssociatedObject</span>(self, MTLModelCachedPropertyKeysKey);<br>	<span class="hljs-keyword">if</span> (cachedKeys != nil) <span class="hljs-keyword">return</span> cachedKeys;<br><br>	NSMutableSet *keys = [NSMutableSet set];<br>    <span class="hljs-comment">//遍历 model 所有的属性，判断哪些属性是符合要求的，加入 keys 变量中</span><br>   <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>	[self enumeratePropertiesUsingBlock:^(<span class="hljs-type">objc_property_t</span> property, BOOL *stop) &#123;<br>        <span class="hljs-comment">//获取属性名字</span><br>		NSString *key = @(<span class="hljs-built_in">property_getName</span>(property));<br>        <span class="hljs-comment">//判断哪些属性是可以做映射的，即不是 MTLPropertyStorageNone 的都可以做映射</span><br>        <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>		<span class="hljs-keyword">if</span> ([self storageBehaviorForPropertyWithKey:key] != MTLPropertyStorageNone) &#123;<br>			 [keys addObject:key];<br>		&#125;<br>	&#125;];<br><br>	<span class="hljs-comment">// It doesn&#x27;t really matter if we replace another thread&#x27;s work, since we do</span><br>	<span class="hljs-comment">// it atomically and the result should be the same.</span><br>    <span class="hljs-comment">// 给这个对象设置属性列表的缓存</span><br>	<span class="hljs-built_in">objc_setAssociatedObject</span>(self, MTLModelCachedPropertyKeysKey, keys, OBJC_ASSOCIATION_COPY);<br><br>	<span class="hljs-keyword">return</span> keys;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.MTLModel 的enumeratePropertiesUsingBlock类方法，该方法用来遍历 model 的属性</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs CPP">+ (<span class="hljs-type">void</span>)enumeratePropertiesUsingBlock:(<span class="hljs-built_in">void</span> (^)(<span class="hljs-type">objc_property_t</span> property, BOOL *stop))block &#123;<br>	Class cls = self;<br>	BOOL stop = NO;<br>    <span class="hljs-comment">//按 mode l的继承层级，遍历 model 的属性</span><br>	<span class="hljs-keyword">while</span> (!stop &amp;&amp; ![cls isEqual:MTLModel.<span class="hljs-keyword">class</span>]) &#123;<br>		<span class="hljs-type">unsigned</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//获取属性列表</span><br>		<span class="hljs-type">objc_property_t</span> *properties = <span class="hljs-built_in">class_copyPropertyList</span>(cls, &amp;count);<br>		cls = cls.superclass;<br>		<span class="hljs-keyword">if</span> (properties == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">continue</span>;<br>		@onExit &#123;<br>			<span class="hljs-built_in">free</span>(properties);<br>		&#125;;<br>        <span class="hljs-comment">//block回调</span><br>		<span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>			<span class="hljs-built_in">block</span>(properties[i], &amp;stop);<br>			<span class="hljs-keyword">if</span> (stop) <span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5.MTLModel 的 storageBehaviorForPropertyWithKey 类方法，用于判断 model 的属性是否可以用来做转化</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled11.webp" srcset="/img/loading.gif" lazyload class="" title="image">

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs CPP">+ (MTLPropertyStorage)storageBehaviorForPropertyWithKey:(NSString *)propertyKey &#123;<br>    <span class="hljs-comment">//根据属性名获取属性的相关内容</span><br>	<span class="hljs-type">objc_property_t</span> property = <span class="hljs-built_in">class_getProperty</span>(self.<span class="hljs-keyword">class</span>, propertyKey.UTF8String);<br>	<span class="hljs-keyword">if</span> (property == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> MTLPropertyStorageNone;<br>  <span class="hljs-comment">//将属性的 runtime 表示方法 转成 Mantle 的表示方法</span><br>  <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>	mtl_propertyAttributes *attributes = <span class="hljs-built_in">mtl_copyPropertyAttributes</span>(property);<br>	@onExit &#123;<br>		<span class="hljs-built_in">free</span>(attributes);<br>	&#125;;<br>  <span class="hljs-comment">//是否有 setter 和 getter 方法</span><br>	BOOL hasGetter = [self instancesRespondToSelector:attributes-&gt;getter];<br>	BOOL hasSetter = [self instancesRespondToSelector:attributes-&gt;setter]; <br>	<span class="hljs-keyword">if</span> (!attributes-&gt;dynamic &amp;&amp; attributes-&gt;ivar == <span class="hljs-literal">NULL</span> &amp;&amp; !hasGetter &amp;&amp; !hasSetter) &#123;<br>        <span class="hljs-comment">// attributes 不是 dynamic ( @dynamic 就是要来告诉编译器，代码中用 @dynamic 修饰的属性，其 getter 和 setter 方法会在程序运行的时候或者用其他方式动态绑定，以便让编译器通过编译)</span><br>        <span class="hljs-comment">// attributes-&gt;ivar 为空</span><br>        <span class="hljs-comment">//没有 getter 方法</span><br>        <span class="hljs-comment">//没有 setter 方法</span><br>		<span class="hljs-keyword">return</span> MTLPropertyStorageNone;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (attributes-&gt;readonly &amp;&amp; attributes-&gt;ivar == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-comment">//attributes 是 readonly</span><br>        <span class="hljs-comment">//attributes-&gt;ivar 变量为空</span><br>		<span class="hljs-keyword">if</span> ([self isEqual:MTLModel.<span class="hljs-keyword">class</span>]) &#123;<br>            <span class="hljs-comment">//是否是 MTLModel 的属性</span><br>			<span class="hljs-keyword">return</span> MTLPropertyStorageNone;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// Check superclass in case the subclass redeclares a property that</span><br>			<span class="hljs-comment">// falls through</span><br>            <span class="hljs-comment">// 检查一下超类属性，防止超类属性被子类重新声明</span><br>			<span class="hljs-keyword">return</span> [self.superclass storageBehaviorForPropertyWithKey:propertyKey];<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> MTLPropertyStoragePermanent;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>6.EXTRuntimeExtensions 的 mtl_copyPropertyAttributes 方法，作用是将属性的runtime表示形式转成更好理解的 Mantle 表示形式。该方法比较枯燥无味且相对来说难以理解，可以略过，不影响 Mantle 解读。<br>该方法需要结合苹果的官方<a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html">Runtime</a>开发文档再进行单步调试才能更好的理解。</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled12.webp" srcset="/img/loading.gif" lazyload class="" title="image">

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">//以属性date为例,说明整个转化过程，具体的信息可以参考苹果官方的 runtime 文档</span><br><span class="hljs-comment">// @property (nonatomic,strong) NSString *date </span><br><br><span class="hljs-function">mtl_propertyAttributes *<span class="hljs-title">mtl_copyPropertyAttributes</span> <span class="hljs-params">(<span class="hljs-type">objc_property_t</span> property)</span> </span>&#123;<br>    <span class="hljs-comment">//The string starts with a T followed by the @encode type and a comma(逗号), and finishes with a V followed by the name of the backing instance variable.</span><br>    <span class="hljs-comment">//属性 date 的 runtime 表示形式为 &quot;T@\&quot;NSString\&quot;,&amp;,N,V_date&quot;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> * <span class="hljs-type">const</span> attrString = <span class="hljs-built_in">property_getAttributes</span>(property);<br>    <span class="hljs-keyword">if</span> (!attrString) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Could not get attribute string from property %s\n&quot;</span>, <span class="hljs-built_in">property_getName</span>(property));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-comment">//必须以 T 开头</span><br>    <span class="hljs-keyword">if</span> (attrString[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;T&#x27;</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Expected attribute string \&quot;%s\&quot; for property %s to start with &#x27;T&#x27;\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-comment">//去掉 T 变成 &quot;@\&quot;NSString\&quot;,&amp;,N,V_date&quot;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *typeString = attrString + <span class="hljs-number">1</span>;<span class="hljs-comment">//attrString代表字符串的起始地址，地址加1表示字符串截取</span><br><br>    <span class="hljs-comment">// Obtains the actual size and the aligned size of an encoded type.</span><br>    <span class="hljs-comment">// 去掉 @encode 字符串 变成 &quot;,&amp;,N,V_date&quot;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *next = <span class="hljs-built_in">NSGetSizeAndAlignment</span>(typeString, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (!next) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Could not read past type in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>   <span class="hljs-comment">// 以属性 date 为例差11个字符</span><br>    <span class="hljs-type">size_t</span> typeLength = next - typeString;<br>    <span class="hljs-keyword">if</span> (!typeLength) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Invalid type in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// allocate enough space for the structure and the type string (plus a NUL)</span><br>    <span class="hljs-comment">// 将propertyAttributes变成mtl_propertyAttributes类型</span><br>    <span class="hljs-comment">// TODO 长度的计算？为什么是这样计算？</span><br>    mtl_propertyAttributes *attributes = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(mtl_propertyAttributes) + typeLength + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (!attributes) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Could not allocate mtl_propertyAttributes structure for attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// copy the type string</span><br>    <span class="hljs-comment">// 复制属性的类型</span><br>    <span class="hljs-built_in">strncpy</span>(attributes-&gt;type, typeString, typeLength);<br>    attributes-&gt;type[typeLength] = <span class="hljs-string">&#x27;\0&#x27;</span>;<span class="hljs-comment">//字符串结尾</span><br><br>    <span class="hljs-comment">// if this is an object type, and immediately followed by a quoted string...</span><br>    <span class="hljs-keyword">if</span> (typeString[<span class="hljs-number">0</span>] == *(@<span class="hljs-built_in">encode</span>(id)) &amp;&amp; typeString[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;&quot;&#x27;</span>) &#123;<br>        <span class="hljs-comment">// we should be able to extract a class name</span><br>        <span class="hljs-comment">// &quot;NSString\&quot;,&amp;,N,V_date&quot;</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *className = typeString + <span class="hljs-number">2</span>;<span class="hljs-comment">//字符串截取</span><br><br>        <span class="hljs-comment">//extern char *strchr(const char *s,char c);查找字符串s中首次出现字符c的位置。</span><br>        <span class="hljs-comment">//&quot;\&quot;,&amp;,N,V_date&quot;</span><br>        next = <span class="hljs-built_in">strchr</span>(className, <span class="hljs-string">&#x27;&quot;&#x27;</span>);<br><br>        <span class="hljs-keyword">if</span> (!next) &#123;<br>            <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Could not read class name in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (className != next) &#123;<br>            <span class="hljs-comment">// 通过内存地址相减 0x0000000104f0347e((const char *) next) - 0x0000000104f03476((const char *) className) = 8</span><br>            <span class="hljs-type">size_t</span> classNameLength = next - className;<br>            <span class="hljs-type">char</span> trimmedName[classNameLength + <span class="hljs-number">1</span>];<span class="hljs-comment">//创建用于存放属性类型的数组</span><br><br>            <span class="hljs-built_in">strncpy</span>(trimmedName, className, classNameLength);<span class="hljs-comment">//复制属性类型到trimmedName</span><br>            trimmedName[classNameLength] = <span class="hljs-string">&#x27;\0&#x27;</span>;<span class="hljs-comment">//数组末尾结束符号</span><br><br>            <span class="hljs-comment">// attempt to look up the class in the runtime</span><br>            attributes-&gt;objectClass = <span class="hljs-built_in">objc_getClass</span>(trimmedName);<span class="hljs-comment">//设置属性类型</span><br>        &#125;<br>    &#125;<br>     <span class="hljs-comment">// &quot;\&quot;,&amp;,N,V_date&quot;</span><br>    <span class="hljs-keyword">if</span> (*next != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-comment">// skip past any junk before the first flag</span><br>        <span class="hljs-comment">// &quot;,&amp;,N,V_date&quot;</span><br>        next = <span class="hljs-built_in">strchr</span>(next, <span class="hljs-string">&#x27;,&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (next &amp;&amp; *next == <span class="hljs-string">&#x27;,&#x27;</span>) &#123;<br>        <span class="hljs-comment">//第一次循环 &amp;</span><br>        <span class="hljs-comment">//第一次循环 N</span><br>        <span class="hljs-comment">//第一次循环 V</span><br>        <span class="hljs-type">char</span> flag = next[<span class="hljs-number">1</span>];<br>        next += <span class="hljs-number">2</span>;<br><br>        <span class="hljs-keyword">switch</span> (flag) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\0&#x27;</span>:<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;R&#x27;</span>:<br>            <span class="hljs-comment">//The property is read-only (readonly).</span><br>            attributes-&gt;readonly = YES;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;C&#x27;</span>:<br>            <span class="hljs-comment">//The property is a copy of the value last assigned (copy).</span><br>            attributes-&gt;memoryManagementPolicy = mtl_propertyMemoryManagementPolicyCopy;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&amp;&#x27;</span>:<br>            <span class="hljs-comment">//The property is a reference to the value last assigned (retain).</span><br>            attributes-&gt;memoryManagementPolicy = mtl_propertyMemoryManagementPolicyRetain;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;N&#x27;</span>:<br>            <span class="hljs-comment">//The property is non-atomic (nonatomic).</span><br>            attributes-&gt;nonatomic = YES;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;G&#x27;</span>:<br>            <span class="hljs-comment">//The property defines a custom getter selector name. The name follows the G (for example, GcustomGetter,).</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;S&#x27;</span>:<br>            <span class="hljs-comment">//The property defines a custom setter selector name. The name follows the S (for example, ScustomSetter:,).</span><br>            &#123;<br>                <span class="hljs-type">const</span> <span class="hljs-type">char</span> *nextFlag = <span class="hljs-built_in">strchr</span>(next, <span class="hljs-string">&#x27;,&#x27;</span>);<br>                SEL name = <span class="hljs-literal">NULL</span>;<br><br>                <span class="hljs-keyword">if</span> (!nextFlag) &#123;<br>                    <span class="hljs-comment">// assume that the rest of the string is the selector</span><br>                    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *selectorString = next;<br>                    next = <span class="hljs-string">&quot;&quot;</span>;<br><br>                    name = <span class="hljs-built_in">sel_registerName</span>(selectorString);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">size_t</span> selectorLength = nextFlag - next;<br>                    <span class="hljs-keyword">if</span> (!selectorLength) &#123;<br>                        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Found zero length selector name in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>                        <span class="hljs-keyword">goto</span> errorOut;<br>                    &#125;<br><br>                    <span class="hljs-type">char</span> selectorString[selectorLength + <span class="hljs-number">1</span>];<br><br>                    <span class="hljs-built_in">strncpy</span>(selectorString, next, selectorLength);<br>                    selectorString[selectorLength] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>                    name = <span class="hljs-built_in">sel_registerName</span>(selectorString);<br>                    next = nextFlag;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (flag == <span class="hljs-string">&#x27;G&#x27;</span>)<br>                    attributes-&gt;getter = name;<br>                <span class="hljs-keyword">else</span><br>                    attributes-&gt;setter = name;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;D&#x27;</span>:<br>            <span class="hljs-comment">//The property is dynamic (@dynamic).</span><br>            attributes-&gt;dynamic = YES;<br>            attributes-&gt;ivar = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;V&#x27;</span>:<br>            <span class="hljs-comment">// assume that the rest of the string (if present) is the ivar name</span><br>            <span class="hljs-comment">// V 之后的是变量名称</span><br>            <span class="hljs-keyword">if</span> (*next == <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>                <span class="hljs-comment">// if there&#x27;s nothing there, let&#x27;s assume this is dynamic</span><br>                attributes-&gt;ivar = <span class="hljs-literal">NULL</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//取得变量名称</span><br>                attributes-&gt;ivar = next;<br>                next = <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;W&#x27;</span>:<br>             <span class="hljs-comment">//The property is a weak reference (__weak).</span><br>            attributes-&gt;weak = YES;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;P&#x27;</span>:<br>            <span class="hljs-comment">//The property is eligible for garbage collection.</span><br>            attributes-&gt;canBeCollected = YES;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;t&#x27;</span>:<br>            <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Old-style type encoding is unsupported in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, attrString, <span class="hljs-built_in">property_getName</span>(property));<br><br>            <span class="hljs-comment">// skip over this type encoding</span><br>            <span class="hljs-keyword">while</span> (*next != <span class="hljs-string">&#x27;,&#x27;</span> &amp;&amp; *next != <span class="hljs-string">&#x27;\0&#x27;</span>)<br>                ++next;<br><br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;ERROR: Unrecognized attribute string flag &#x27;%c&#x27; in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, flag, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (next &amp;&amp; *next != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Warning: Unparsed data \&quot;%s\&quot; in attribute string \&quot;%s\&quot; for property %s\n&quot;</span>, next, attrString, <span class="hljs-built_in">property_getName</span>(property));<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!attributes-&gt;getter) &#123;<br>        <span class="hljs-comment">// use the property name as the getter by default</span><br>        <span class="hljs-comment">//使用默认的 getter 方法</span><br>        attributes-&gt;getter = <span class="hljs-built_in">sel_registerName</span>(<span class="hljs-built_in">property_getName</span>(property));<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!attributes-&gt;setter) &#123;<br>        <span class="hljs-comment">//使用默认的 setter 方法</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *propertyName = <span class="hljs-built_in">property_getName</span>(property);<br>        <span class="hljs-type">size_t</span> propertyNameLength = <span class="hljs-built_in">strlen</span>(propertyName);<br><br>        <span class="hljs-comment">// we want to transform the name to setProperty: style</span><br>        <span class="hljs-type">size_t</span> setterLength = propertyNameLength + <span class="hljs-number">4</span>;<br><br>        <span class="hljs-type">char</span> setterName[setterLength + <span class="hljs-number">1</span>];<br>        <span class="hljs-built_in">strncpy</span>(setterName, <span class="hljs-string">&quot;set&quot;</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-built_in">strncpy</span>(setterName + <span class="hljs-number">3</span>, propertyName, propertyNameLength);<br><br>        <span class="hljs-comment">// capitalize property name for the setter</span><br>        setterName[<span class="hljs-number">3</span>] = (<span class="hljs-type">char</span>)<span class="hljs-built_in">toupper</span>(setterName[<span class="hljs-number">3</span>]);<br><br>        setterName[setterLength - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;:&#x27;</span>;<br>        setterName[setterLength] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>        attributes-&gt;setter = <span class="hljs-built_in">sel_registerName</span>(setterName);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> attributes;<br><br>errorOut:<br>    <span class="hljs-built_in">free</span>(attributes);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>7.在获取了 Mantle 需要的属性之后，接下来就需要做一些转化操作了。MTLJSONAdapter 的类方法 valueTransformersForModelClass 主要是将 JSONKeyPath 的值转成 model 的属性声明的类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">//对值做类型转化,值类型的转化方法由 model 提供</span><br>+ (NSDictionary *)valueTransformersForModelClass:(Class)modelClass &#123;<br>    <span class="hljs-comment">//基本判断</span><br>    <span class="hljs-built_in">NSParameterAssert</span>(modelClass != nil);<br>    <span class="hljs-built_in">NSParameterAssert</span>([modelClass conformsToProtocol:@<span class="hljs-built_in">protocol</span>(MTLJSONSerializing)]);<br>    NSMutableDictionary *result = [NSMutableDictionary dictionary];<br>    <br>    <span class="hljs-comment">//依次为每个属性拼接值类型转化方法并判断 model 是否实现了该方法</span><br>    <span class="hljs-keyword">for</span> (NSString *key in [modelClass propertyKeys]) &#123;<br>   <br>        <span class="hljs-comment">// 1、判断 model 是否实现了 +&lt;key&gt;JSONTransformer 类型方法</span><br>        SEL selector = <span class="hljs-built_in">MTLSelectorWithKeyPattern</span>(key, <span class="hljs-string">&quot;JSONTransformer&quot;</span>);<br>        <span class="hljs-comment">//判断是否有实现该方法</span><br>        <span class="hljs-keyword">if</span> ([modelClass respondsToSelector:selector]) &#123;<br>            <span class="hljs-comment">//取得该方法的实现，调用该方法并获取该方法的返回值</span><br>            IMP imp = [modelClass methodForSelector:selector];<br>            NSValueTransformer * (*function)(id, SEL) = (__typeof__(function))imp;<br>            NSValueTransformer *transformer = <span class="hljs-built_in">function</span>(modelClass, selector);<br>            <span class="hljs-comment">// 为属性保存 NSValueTransformer 对象</span><br>            <span class="hljs-keyword">if</span> (transformer != nil) result[key] = transformer;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">//2、判断 model 是否实现了 +JSONTransformerForKey: 类型方法</span><br>        <span class="hljs-keyword">if</span> ([modelClass respondsToSelector:@<span class="hljs-built_in">selector</span>(JSONTransformerForKey:)]) &#123;<br>            NSValueTransformer *transformer = [modelClass JSONTransformerForKey:key];<br>            <span class="hljs-comment">// 为属性保存 NSValueTransformer 对象</span><br>            <span class="hljs-keyword">if</span> (transformer != nil) result[key] = transformer;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-type">objc_property_t</span> property = <span class="hljs-built_in">class_getProperty</span>(modelClass, key.UTF8String);<br>        <span class="hljs-keyword">if</span> (property == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">continue</span>;<br>       <span class="hljs-comment">//将属性的runtime 表示形式 转成 Mantle 的表示形式</span><br>        mtl_propertyAttributes *attributes = <span class="hljs-built_in">mtl_copyPropertyAttributes</span>(property);<br>        @onExit &#123;<br>            <span class="hljs-built_in">free</span>(attributes);<br>        &#125;;<br>      <span class="hljs-comment">//3、其他值类型转化</span><br>        NSValueTransformer *transformer = nil;<br>        <span class="hljs-keyword">if</span> (*(attributes-&gt;type) == *(@<span class="hljs-built_in">encode</span>(id))) &#123;<br>            Class propertyClass = attributes-&gt;objectClass;<br>            <span class="hljs-keyword">if</span> (propertyClass != nil) &#123;<br>                <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>                <span class="hljs-comment">//如果是对象类型，那么取出类型转化的 NSValueTransformer 对象</span><br>                transformer = [self transformerForModelPropertiesOfClass:propertyClass];<br>            &#125;<br>             <span class="hljs-comment">//用于做属性的值类型转换</span><br>            <span class="hljs-keyword">if</span> (transformer == nil) transformer = [NSValueTransformer mtl_validatingTransformerForClass:propertyClass ?: NSObject.<span class="hljs-keyword">class</span>];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//区分BOOL类型</span><br>            transformer = [self transformerForModelPropertiesOfObjCType:attributes-&gt;type] ?: [NSValueTransformer mtl_validatingTransformerForClass:NSValue.<span class="hljs-keyword">class</span>];<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (transformer != nil) result[key] = transformer;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>8.MTLJSONAdapter 的 - (id)modelFromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error 方法完成字典转成 model 操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><br>- (id)modelFromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error &#123;<br>    <span class="hljs-comment">//判断是否实现 classForParsingJSONDictionary: 协议</span><br>    <span class="hljs-keyword">if</span> ([self.modelClass respondsToSelector:@<span class="hljs-built_in">selector</span>(classForParsingJSONDictionary:)]) &#123;<br>        <span class="hljs-comment">//获取Class</span><br>        Class <span class="hljs-keyword">class</span> = [self.modelClass classForParsingJSONDictionary:JSONDictionary];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">class</span> == nil) &#123;<br>            <span class="hljs-keyword">if</span> (error != <span class="hljs-literal">NULL</span>) &#123;<br>                <span class="hljs-comment">//错误处理</span><br>                NSDictionary *userInfo = @&#123;<br>                    NSLocalizedDescriptionKey: <span class="hljs-built_in">NSLocalizedString</span>(@<span class="hljs-string">&quot;Could not parse JSON&quot;</span>, @<span class="hljs-string">&quot;&quot;</span>),<br>                    NSLocalizedFailureReasonErrorKey: <span class="hljs-built_in">NSLocalizedString</span>(@<span class="hljs-string">&quot;No model class could be found to parse the JSON dictionary.&quot;</span>, @<span class="hljs-string">&quot;&quot;</span>)<br>                &#125;;<br>                *error = [NSError errorWithDomain:MTLJSONAdapterErrorDomain code:MTLJSONAdapterErrorNoClassFound userInfo:userInfo];<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> nil;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">class</span> != self.modelClass) &#123;<br>            <span class="hljs-comment">//实现协议判断</span><br>            <span class="hljs-built_in">NSAssert</span>([<span class="hljs-keyword">class</span> conformsToProtocol:@<span class="hljs-built_in">protocol</span>(MTLJSONSerializing)], @<span class="hljs-string">&quot;Class %@ returned from +classForParsingJSONDictionary: does not conform to &lt;MTLJSONSerializing&gt;&quot;</span>, <span class="hljs-keyword">class</span>);<br><br>            MTLJSONAdapter *otherAdapter = [self JSONAdapterForModelClass:<span class="hljs-keyword">class</span> error:error];<br><br>            <span class="hljs-keyword">return</span> [otherAdapter modelFromJSONDictionary:JSONDictionary error:error];<br>        &#125;<br>    &#125;<br><br>    NSMutableDictionary *dictionaryValue = [[NSMutableDictionary alloc] initWithCapacity:JSONDictionary.count];<br>    <span class="hljs-comment">//取出 model 的属性 key</span><br>    <span class="hljs-keyword">for</span> (NSString *propertyKey in [self.modelClass propertyKeys]) &#123;<br>        <span class="hljs-comment">//取出JSONKeyPath</span><br>        id JSONKeyPaths = self.JSONKeyPathsByPropertyKey[propertyKey];<br><br>        <span class="hljs-keyword">if</span> (JSONKeyPaths == nil) <span class="hljs-keyword">continue</span>;<br><br>        id value;<br>        <span class="hljs-comment">//TODO 这个判断数组的用处？</span><br>        <span class="hljs-keyword">if</span> ([JSONKeyPaths isKindOfClass:NSArray.<span class="hljs-keyword">class</span>]) &#123;<br>            NSMutableDictionary *dictionary = [NSMutableDictionary dictionary];<br>            <span class="hljs-keyword">for</span> (NSString *keyPath in JSONKeyPaths) &#123;<br>                BOOL success;<br>                <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>                id value = [JSONDictionary mtl_valueForJSONKeyPath:keyPath success:&amp;success error:error];<br>                <span class="hljs-keyword">if</span> (!success) <span class="hljs-keyword">return</span> nil;<br>                <span class="hljs-keyword">if</span> (value != nil) dictionary[keyPath] = value;<br>            &#125;<br>            value = dictionary;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            BOOL success;<br>           <span class="hljs-comment">//取出字典中JSONKeyPaths对应的值</span><br>           <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>            value = [JSONDictionary mtl_valueForJSONKeyPath:JSONKeyPaths success:&amp;success error:error];<br>            <span class="hljs-keyword">if</span> (!success) <span class="hljs-keyword">return</span> nil;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (value == nil) <span class="hljs-keyword">continue</span>;<br>        @<span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//取出值转化的 NSValueTransformer 对象，若是对象为空则说明该 propertyKey 不需要做值转化</span><br>            NSValueTransformer *transformer = self.valueTransformersByPropertyKey[propertyKey];<br>            <span class="hljs-keyword">if</span> (transformer != nil) &#123;<br>                <span class="hljs-comment">// Map NSNull -&gt; nil for the transformer, and then back for the</span><br>                <span class="hljs-comment">// dictionary we&#x27;re going to insert into.</span><br>                <span class="hljs-keyword">if</span> ([value isEqual:NSNull.null]) value = nil;<br>                <span class="hljs-comment">//值转化操作</span><br>                <span class="hljs-keyword">if</span> ([transformer respondsToSelector:@<span class="hljs-built_in">selector</span>(transformedValue:success:error:)]) &#123;<br>                <span class="hljs-comment">//转化过程有回调 </span><br>                    id&lt;MTLTransformerErrorHandling&gt; errorHandlingTransformer = (id)transformer;<br>                    BOOL success = YES;<br>                    value = [errorHandlingTransformer transformedValue:value success:&amp;success error:error];<br>                    <span class="hljs-keyword">if</span> (!success) <span class="hljs-keyword">return</span> nil;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//不需要转化过程回调，直接转化</span><br>                <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>                    value = [transformer transformedValue:value];<br>                &#125;<br>                <span class="hljs-keyword">if</span> (value == nil) value = NSNull.null;<br>            &#125;<br>            <span class="hljs-comment">// 保存被 NSValueTransformer 转化过的 JSONKeyPath 的值</span><br>            dictionaryValue[propertyKey] = value;<br>        &#125; @<span class="hljs-built_in">catch</span> (NSException *ex) &#123;<br>           <span class="hljs-comment">//省略错误处理代码</span><br>            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;*** Caught exception %@ parsing JSON key path \&quot;%@\&quot; from: %@&quot;</span>, ex, JSONKeyPaths, JSONDictionary);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//将字典转换成 model </span><br>    <span class="hljs-comment">// **该方法后文有详细的实现解读**</span><br>    id model = [self.modelClass modelWithDictionary:dictionaryValue error:error];<br>    <span class="hljs-comment">//进行错误验证</span><br>    <span class="hljs-keyword">return</span> [model validate:error] ? model : nil;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>9.NSDictionary+MTLJSONKeyPath 的 - (id)mtl_valueForJSONKeyPath:(NSString *)JSONKeyPath success:(BOOL *)success error:(NSError **)error; 方法作用在于根据 JSONKeyPath 从 JSON 字典中取出对应的值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs CPP">- (id)mtl_valueForJSONKeyPath:(NSString *)JSONKeyPath success:(BOOL *)success error:(NSError **)error &#123;<br>    <span class="hljs-comment">//TODO 这个按.分割字符串是什么意思呢？在哪里用到呢？在文章末尾说明2</span><br>	NSArray *components = [JSONKeyPath componentsSeparatedByString:@<span class="hljs-string">&quot;.&quot;</span>];<br>	id result = self;<span class="hljs-comment">//字典</span><br>	<span class="hljs-keyword">for</span> (NSString *component in components) &#123;<br>		<span class="hljs-comment">// Check the result before resolving the key path component to not</span><br>		<span class="hljs-comment">// affect the last value of the path.</span><br>		<span class="hljs-keyword">if</span> (result == nil || result == NSNull.null) <span class="hljs-keyword">break</span>;<br>		<span class="hljs-keyword">if</span> (![result isKindOfClass:NSDictionary.<span class="hljs-keyword">class</span>]) &#123;<br>                 <span class="hljs-comment">//错误处理代码</span><br>		&#125;<br>        <span class="hljs-comment">//以JSONKeyPath为key取出JSON字典中的值</span><br>		result = result[component];<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (success != <span class="hljs-literal">NULL</span>) *success = YES;<br><br>	<span class="hljs-keyword">return</span> result;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>10.在取得了JSONKeyPath对应的 value 之后，那么下一步操作就是要根据 model 值转化方法返回的 NSValueTransformer 对象做值转化操作</p>
<p>MTLValueTransformer 是一个基于 block 操作的值转化对象，实现 JSON字典–&gt;model 的转化。而MTLReversibleValueTransformer<br>实现逆向转化操作。</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled13.webp" srcset="/img/loading.gif" lazyload class="" title="image">

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><br>@implementation MTLValueTransformer<br><br><span class="hljs-comment">//转化操作，由 model 的 block 具体实现转化操作，返回值为转化后的值</span><br>- (id)transformedValue:(id)value &#123;<br>	NSError *error = nil;<br>	BOOL success = YES;<br><br>	<span class="hljs-keyword">return</span> self.forwardBlock(value, &amp;success, &amp;error);<br>&#125;<br><span class="hljs-comment">//带回调的转化操作，由 model 的 block 具体实现转化操作，返回值为转化后的值</span><br>- (id)transformedValue:(id)value success:(BOOL *)outerSuccess error:(NSError **)outerError &#123;<br>	NSError *error = nil;<br>	BOOL success = YES;<br>    <span class="hljs-comment">//转化后的值</span><br>	id transformedValue = self.forwardBlock(value, &amp;success, &amp;error);<br><br>	<span class="hljs-keyword">if</span> (outerSuccess != <span class="hljs-literal">NULL</span>) *outerSuccess = success;<br>	<span class="hljs-keyword">if</span> (outerError != <span class="hljs-literal">NULL</span>) *outerError = error;<br><br>	<span class="hljs-keyword">return</span> transformedValue;<br>&#125;<br><br>@end<br><br><span class="hljs-comment">//反向转化 model --&gt; JSON 字典</span><br>@implementation MTLReversibleValueTransformer<br><span class="hljs-comment">//反向转化操作，由 model 的 block 具体实现转化操作，返回值为转化后的值</span><br>- (id)reverseTransformedValue:(id)value &#123;<br>	NSError *error = nil;<br>	BOOL success = YES;<br><br>	<span class="hljs-keyword">return</span> self.<span class="hljs-built_in">reverseBlock</span>(value, &amp;success, &amp;error);<br>&#125;<br><span class="hljs-comment">//带回调的转化操作，由 model 的 block 具体实现反向转化操作，返回值为转化后的值</span><br>- (id)reverseTransformedValue:(id)value success:(BOOL *)outerSuccess error:(NSError **)outerError &#123;<br>	NSError *error = nil;<br>	BOOL success = YES;<br>    <span class="hljs-comment">//转化后的值</span><br>	id transformedValue = self.<span class="hljs-built_in">reverseBlock</span>(value, &amp;success, &amp;error);<br><br>	<span class="hljs-keyword">if</span> (outerSuccess != <span class="hljs-literal">NULL</span>) *outerSuccess = success;<br>	<span class="hljs-keyword">if</span> (outerError != <span class="hljs-literal">NULL</span>) *outerError = error;<br>    <br>	<span class="hljs-keyword">return</span> transformedValue;<br>&#125;<br><br>@end<br></code></pre></td></tr></table></figure>

<p>11.在处理的值转化之后，那么接下来就是要将从 JSON 字典中获取的 model 属性值赋值给对应的 model 对象了。在 MTLJSONAdapter 的 - (id)modelFromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error 的实现中的最后一部分代码就是用来生成对应的 model 对象的。</p>
<img src="/2016/11/04/reading-source-code-of-Mantle/Untitled14.webp" srcset="/img/loading.gif" lazyload class="" title="image">

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">//MTLModel  代码片段</span><br><br><span class="hljs-comment">//使用字典初始化 model </span><br>+ (instancetype)modelWithDictionary:(NSDictionary *)dictionary error:(NSError **)error &#123;<br>	<span class="hljs-keyword">return</span> [[self alloc] initWithDictionary:dictionary error:error];<br>&#125;<br>......<br><span class="hljs-comment">//使用字典初始化 model </span><br>- (instancetype)initWithDictionary:(NSDictionary *)dictionary error:(NSError **)error &#123;<br>	self = [self init];<br>	<span class="hljs-keyword">if</span> (self == nil) <span class="hljs-keyword">return</span> nil;<br>       <span class="hljs-comment">//取出NSDictionary的key</span><br>	<span class="hljs-keyword">for</span> (NSString *key in dictionary) &#123;<br>		<span class="hljs-comment">// Mark this as being autoreleased, because validateValue may return</span><br>		<span class="hljs-comment">// a new object to be stored in this variable (and we don&#x27;t want ARC to</span><br>		<span class="hljs-comment">// double-free or leak the old or new values).</span><br>		__autoreleasing id value = [dictionary objectForKey:key];<br>		<span class="hljs-keyword">if</span> ([value isEqual:NSNull.null]) value = nil; <br>        <span class="hljs-comment">//判断 model 的这个属性是否可以采用 KVC 来给属性赋值</span><br>		BOOL success = <span class="hljs-built_in">MTLValidateAndSetValue</span>(self, key, value, YES, error);<br>		<span class="hljs-keyword">if</span> (!success) <span class="hljs-keyword">return</span> nil;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> self;<br>&#125;<br><br><br><span class="hljs-comment">//判断 model 的某个属性是否可以采用 KVC 来给属性赋值，然后根据赋值条件给予赋值</span><br><span class="hljs-function"><span class="hljs-type">static</span> BOOL <span class="hljs-title">MTLValidateAndSetValue</span><span class="hljs-params">(id obj, NSString *key, id value, BOOL forceUpdate, NSError **error)</span> </span>&#123;<br>	__autoreleasing id validatedValue = value;<br>	@<span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 当开发者需要验证能不能用KVC设定某个值时，可以调用validateValue: forKey:这个方法来验证</span><br>        <span class="hljs-comment">// 这个方法的默认实现是去类里面寻找是否有一个这样的方法：-(BOOL)validate&lt;Key&gt;:error:</span><br>        <span class="hljs-comment">// 如果有这个方法，就以这个方法的返回值作为判断标准，没有的话就直接返回YES</span><br>		<span class="hljs-keyword">if</span> (![obj validateValue:&amp;validatedValue forKey:key error:error]) <span class="hljs-keyword">return</span> NO;<br>        <span class="hljs-comment">// 设置新值</span><br>        <span class="hljs-comment">// obj 返回的 validatedValue 与 传进来的参数 value 进行对比，若不一致采用validatedValue的值</span><br>        <span class="hljs-comment">// forceUpdate 为 YES 那么也是直接给 key 设置值</span><br>		<span class="hljs-keyword">if</span> (forceUpdate || value != validatedValue) &#123;<br>			[obj setValue:validatedValue forKey:key];<br>		&#125;<br>		<span class="hljs-keyword">return</span> YES;<br>	&#125; @<span class="hljs-built_in">catch</span> (NSException *ex) &#123;<br>		<span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;*** Caught exception setting key \&quot;%@\&quot; : %@&quot;</span>, key, ex);<br>		<span class="hljs-comment">//错误处理代码</span><br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// model 的属性验证，只做验证处理，不做赋值操作</span><br>- (BOOL)validate:(NSError **)error &#123;<br>	<span class="hljs-keyword">for</span> (NSString *key in self.<span class="hljs-keyword">class</span>.propertyKeys) &#123;<br>		id value = [self valueForKey:key];<br>        <span class="hljs-comment">//验证 model 是否有某个属性不能使用 KVC 赋值，若是有属性无法通过 KVC 赋值那么返回 NO。 此时 JSON 字典 --&gt; model 过程会得到一个 nil 对象，model 转化失败</span><br>		BOOL success = <span class="hljs-built_in">MTLValidateAndSetValue</span>(self, key, value, NO, error);<br>		<span class="hljs-keyword">if</span> (!success) <span class="hljs-keyword">return</span> NO;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> YES;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>12.Mantle完成最后的 model 属性验证之后，返回相关的 model 对象。至此 Mantle 的 JSON 字典 –&gt; model 过程就完成了。</p>
<p>13.TODO 的应用场景说明<br> 在文中有 2 个 TODO  说明，限于篇幅统一放在这里说明。可以搜索 TODO 关键字找到文章做 TODO 标记文职<br>&#x2F;&#x2F; TODO [value isKindOfClass:NSArray.class] 这个是判断什么呢？在哪里用到呢？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">//JSON字典</span><br>NSDictionary *JSONDict = @&#123;<br>                               @<span class="hljs-string">&quot;code&quot;</span>:@<span class="hljs-number">200</span>,<br>                               @<span class="hljs-string">&quot;temp&quot;</span> : @<span class="hljs-string">&quot;59.07&quot;</span>,<br>                               @<span class="hljs-string">&quot;temp_max&quot;</span> : @<span class="hljs-string">&quot;63.32&quot;</span><br>                          &#125;;<br><br><br><span class="hljs-comment">//根据上面的 JSON字典 按照正常的处理办法</span><br>@interface TestModel : MTLModel&lt;MTLJSONSerializing&gt;<br>@<span class="hljs-built_in">property</span> (nonatomic,assign) NSInteger code;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) NSString *temp;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) NSString *temp_max;<br>@end<br><br><br><span class="hljs-comment">//但是有些情况下可能想把 temp 和 temp_max 放到一个字典当中。</span><br>@interface TestModel : MTLModel&lt;MTLJSONSerializing&gt;<br>@<span class="hljs-built_in">property</span> (nonatomic,assign) NSInteger code;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) NSDictionary *temp;<br><br>@end<br><span class="hljs-comment">// temp 和 temp_max 放到一个字典当中 ,那么 JSONKeyPathsByPropertyKey 方法做如下实现</span><br>@implementation TestModel<br>+(NSDictionary *)JSONKeyPathsByPropertyKey&#123;<br>    <span class="hljs-keyword">return</span> @&#123;<br>             @<span class="hljs-string">&quot;code&quot;</span>:@<span class="hljs-string">&quot;code&quot;</span>,<br>             @<span class="hljs-string">&quot;temp&quot;</span>:[NSArray arrayWithObjects:@<span class="hljs-string">&quot;temp&quot;</span>, @<span class="hljs-string">&quot;temp_max&quot;</span>,nil]<br>             &#125;;<br>&#125;<br>@end<br></code></pre></td></tr></table></figure>


<p>&#x2F;&#x2F; TODO 这个按.分割字符串是什么意思呢？在哪里用到呢？在文章末尾说明2</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">//JSON字典</span><br>NSDictionary *JSONDict = @&#123;<br>                               @<span class="hljs-string">&quot;code&quot;</span>:@<span class="hljs-number">200</span>,<br>                               @<span class="hljs-string">&quot;weather&quot;</span>:@&#123;<br>                                       @<span class="hljs-string">&quot;temp&quot;</span> : @<span class="hljs-string">&quot;59.07&quot;</span>,<br>                                       @<span class="hljs-string">&quot;temp_max&quot;</span> : @<span class="hljs-string">&quot;63.32&quot;</span>,<br>                                       @<span class="hljs-string">&quot;temp_min&quot;</span> : @<span class="hljs-string">&quot;53.01&quot;</span><br>                                       &#125;<br>                               &#125;;<br><br><br><span class="hljs-comment">//根据上面的 JSON字典 按照正常的处理办法会再给 TestModel 新建一个名为 weather 的对象属性</span><br>@interface TestModel : MTLModel&lt;MTLJSONSerializing&gt;<br>@<span class="hljs-built_in">property</span> (nonatomic,assign) NSInteger code;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) Weather *weather;<br>@end<br><br><br><span class="hljs-comment">//但是有些情况下并不想给 TestModel 新建对象属性，而是把 JSON 字典中所有层级的 JSONKeyPath 都放到第一层级来。</span><br>@interface TestModel : MTLModel&lt;MTLJSONSerializing&gt;<br>@<span class="hljs-built_in">property</span> (nonatomic,assign) NSInteger code;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) NSString *temp;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) NSString *temp_max;<br>@<span class="hljs-built_in">property</span> (nonatomic,strong) NSString *temp_min;<br>@end<br><span class="hljs-comment">//JSON 字典中所有层级的 JSONKeyPath 都放到第一层级,那么 JSONKeyPathsByPropertyKey 方法需要做好对应的层级关系实现</span><br>@implementation TestModel<br>+(NSDictionary *)JSONKeyPathsByPropertyKey&#123;<br>    <span class="hljs-keyword">return</span> @&#123;<br>             @<span class="hljs-string">&quot;code&quot;</span>:@<span class="hljs-string">&quot;code&quot;</span>,<br>             @<span class="hljs-string">&quot;temp&quot;</span>:@<span class="hljs-string">&quot;weather.temp&quot;</span>,<br>             @<span class="hljs-string">&quot;temp_max&quot;</span>:@<span class="hljs-string">&quot;weather.temp_max&quot;</span>,<br>             @<span class="hljs-string">&quot;temp_min&quot;</span>:@<span class="hljs-string">&quot;weather.temp_min&quot;</span>,<br>             &#125;;<br>&#125;<br>@end<br></code></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Mantle 作为一款经典的 JSON 字典 &lt;–&gt; model 转化模型框架，主要是利用 KVC 特性为 model 赋值,其框架设计有不少优点，比如值转化过程的设计等，阅读优秀的开源项目不仅可以扩大技术眼界，也可以增加对代码细节的把控能力。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Mantle/Mantle">https://github.com/Mantle/Mantle</a><br><a target="_blank" rel="noopener" href="http://southpeak.github.io/2015/01/11/sourcecode-mantle/">http://southpeak.github.io/2015/01/11/sourcecode-mantle/</a><br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html">https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/f49ddbf8a2ea">http://www.jianshu.com/p/f49ddbf8a2ea</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/9f039124efef">http://www.jianshu.com/p/9f039124efef</a><br><a target="_blank" rel="noopener" href="https://github.com/johnno1962/Xtrace">https://github.com/johnno1962/Xtrace</a><br><a target="_blank" rel="noopener" href="http://nshipster.com/nsvaluetransformer/">http://nshipster.com/nsvaluetransformer/</a></p>
</blockquote>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">#源码解读</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>iOS 模型框架- Mantle 解读</div>
      <div>https://junbinchencn.github.io/2016/11/04/reading-source-code-of-Mantle/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>斌哥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2016年11月4日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/05/23/talking-about-the-value-of-architecture/" title="谈谈软件架构的价值">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">谈谈软件架构的价值</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2016/08/31/reading-source-code-of-FLAnimatedImage/" title="iOS GIF 动画加载框架 - FLAnimatedImage 解读">
                        <span class="hidden-mobile">iOS GIF 动画加载框架 - FLAnimatedImage 解读</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
